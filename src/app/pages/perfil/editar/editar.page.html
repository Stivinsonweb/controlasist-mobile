<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="cerrar()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Editar Perfil</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="guardar()" [disabled]="perfilForm.invalid || isLoading">
        <ion-icon name="save-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="editar-container">
    
    <!-- Avatar Actual -->
    <div class="avatar-section">
      <ion-avatar class="edit-avatar">
        <img [src]="getAvatarUrl()" [alt]="docente?.nombres" />
      </ion-avatar>
      <p class="avatar-hint">Selecciona un avatar a continuación</p>
    </div>

    <!-- Selector de Avatares -->
    <ion-card class="avatares-card">
      <ion-card-content>
        <h3 class="section-title">
          <ion-icon name="camera-outline"></ion-icon>
          Cambiar Avatar
        </h3>

        <!-- Loading de avatares -->
        <div *ngIf="loadingAvatars" class="avatars-loading">
          <ion-icon name="reload-outline" class="loading-icon spin"></ion-icon>
          <p>Cargando avatares...</p>
        </div>

        <!-- Grid de avatares -->
        <div class="avatars-grid" *ngIf="!loadingAvatars">
          <div 
            *ngFor="let avatar of avatars; let i = index"
            class="avatar-item"
            [class.selected]="selectedAvatarIndex === i"
            (click)="selectAvatar(i)">
            <img [src]="avatar" [alt]="'Avatar ' + (i + 1)" (error)="onImageError($event, i)">
            <ion-icon name="checkmark-circle" class="check-icon" *ngIf="selectedAvatarIndex === i"></ion-icon>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Formulario de Perfil -->
    <ion-card class="form-card">
      <ion-card-content>
        <h3 class="section-title">
          <ion-icon name="person-outline"></ion-icon>
          Información Personal
        </h3>

        <form [formGroup]="perfilForm">
          
          <!-- Email (Solo lectura) -->
          <div class="input-group">
            <ion-label class="input-label">
              <ion-icon name="mail-outline" class="label-icon"></ion-icon>
              Correo electrónico
            </ion-label>
            <ion-item lines="none" class="custom-item disabled-item">
              <ion-input 
                type="email" 
                [value]="docente?.email"
                disabled
                class="custom-input">
              </ion-input>
            </ion-item>
            <p class="field-hint">El correo no se puede modificar</p>
          </div>

          <!-- Nombres -->
          <div class="input-group">
            <ion-label class="input-label">
              <ion-icon name="person-outline" class="label-icon"></ion-icon>
              Nombres <span class="required">*</span>
            </ion-label>
            <ion-item lines="none" class="custom-item" [class.item-error]="nombres?.invalid && nombres?.touched">
              <ion-input 
                type="text" 
                formControlName="nombres"
                placeholder="Tus nombres"
                class="custom-input">
              </ion-input>
            </ion-item>
            <div class="error-message" *ngIf="nombres?.invalid && nombres?.touched">
              <ion-icon name="alert-circle"></ion-icon>
              <span>{{ nombres?.hasError('required') ? 'Los nombres son requeridos' : 'Mínimo 2 caracteres' }}</span>
            </div>
          </div>

          <!-- Apellidos -->
          <div class="input-group">
            <ion-label class="input-label">
              <ion-icon name="person-outline" class="label-icon"></ion-icon>
              Apellidos <span class="required">*</span>
            </ion-label>
            <ion-item lines="none" class="custom-item" [class.item-error]="apellidos?.invalid && apellidos?.touched">
              <ion-input 
                type="text" 
                formControlName="apellidos"
                placeholder="Tus apellidos"
                class="custom-input">
              </ion-input>
            </ion-item>
            <div class="error-message" *ngIf="apellidos?.invalid && apellidos?.touched">
              <ion-icon name="alert-circle"></ion-icon>
              <span>{{ apellidos?.hasError('required') ? 'Los apellidos son requeridos' : 'Mínimo 2 caracteres' }}</span>
            </div>
          </div>

          <!-- Teléfono -->
          <div class="input-group">
            <ion-label class="input-label">
              <ion-icon name="call-outline" class="label-icon"></ion-icon>
              Teléfono
            </ion-label>
            <ion-item lines="none" class="custom-item" [class.item-error]="telefono?.invalid && telefono?.touched">
              <ion-input 
                type="tel" 
                formControlName="telefono"
                placeholder="3001234567"
                maxlength="10"
                class="custom-input">
              </ion-input>
            </ion-item>
            <div class="error-message" *ngIf="telefono?.invalid && telefono?.touched">
              <ion-icon name="alert-circle"></ion-icon>
              <span>El teléfono debe tener entre 7 y 10 dígitos</span>
            </div>
          </div>

          <!-- Entidad -->
          <div class="input-group">
            <ion-label class="input-label">
              <ion-icon name="business-outline" class="label-icon"></ion-icon>
              Entidad
            </ion-label>
            <ion-item lines="none" class="custom-item">
              <ion-input 
                type="text" 
                formControlName="entidad"
                placeholder="Universidad o Institución"
                class="custom-input">
              </ion-input>
            </ion-item>
          </div>

          <!-- Programa -->
          <div class="input-group">
            <ion-label class="input-label">
              <ion-icon name="school-outline" class="label-icon"></ion-icon>
              Programa
            </ion-label>
            <ion-item lines="none" class="custom-item">
              <ion-input 
                type="text" 
                formControlName="programa"
                placeholder="Programa académico"
                class="custom-input">
              </ion-input>
            </ion-item>
          </div>

          <!-- Área -->
          <div class="input-group">
            <ion-label class="input-label">
              <ion-icon name="briefcase-outline" class="label-icon"></ion-icon>
              Área
            </ion-label>
            <ion-item lines="none" class="custom-item">
              <ion-input 
                type="text" 
                formControlName="area"
                placeholder="Área de conocimiento"
                class="custom-input">
              </ion-input>
            </ion-item>
          </div>

        </form>
      </ion-card-content>
    </ion-card>

    <!-- Cambiar Contraseña -->
    <ion-card class="form-card password-card">
      <ion-card-content>
        <h3 class="section-title">
          <ion-icon name="lock-closed-outline"></ion-icon>
          Cambiar Contraseña
        </h3>

        <form [formGroup]="passwordForm">
          
          <!-- Contraseña Actual -->
          <div class="input-group">
            <ion-label class="input-label">
              <ion-icon name="lock-closed-outline" class="label-icon"></ion-icon>
              Contraseña Actual <span class="required">*</span>
            </ion-label>
            <ion-item lines="none" class="custom-item" [class.item-error]="currentPassword?.invalid && currentPassword?.touched">
              <ion-input 
                [type]="showCurrentPassword ? 'text' : 'password'"
                formControlName="currentPassword"
                placeholder="Tu contraseña actual"
                class="custom-input">
                <ion-icon 
                  [name]="showCurrentPassword ? 'eye-off-outline' : 'eye-outline'" 
                  slot="end" 
                  class="toggle-password"
                  (click)="toggleCurrentPassword()">
                </ion-icon>
              </ion-input>
            </ion-item>
            <div class="error-message" *ngIf="currentPassword?.invalid && currentPassword?.touched">
              <ion-icon name="alert-circle"></ion-icon>
              <span>La contraseña actual es requerida</span>
            </div>
          </div>

          <!-- Nueva Contraseña -->
          <div class="input-group">
            <ion-label class="input-label">
              <ion-icon name="lock-closed-outline" class="label-icon"></ion-icon>
              Nueva Contraseña <span class="required">*</span>
            </ion-label>
            <ion-item lines="none" class="custom-item" [class.item-error]="newPassword?.invalid && newPassword?.touched">
              <ion-input 
                [type]="showNewPassword ? 'text' : 'password'"
                formControlName="newPassword"
                placeholder="Mínimo 8 caracteres"
                class="custom-input">
                <ion-icon 
                  [name]="showNewPassword ? 'eye-off-outline' : 'eye-outline'" 
                  slot="end" 
                  class="toggle-password"
                  (click)="toggleNewPassword()">
                </ion-icon>
              </ion-input>
            </ion-item>
            
            <!-- Indicadores de fortaleza -->
            <div class="password-requirements" *ngIf="newPassword?.value">
              <div class="requirement-item" [class.valid]="newPassword?.value.length >= 8">
                <ion-icon [name]="newPassword?.value.length >= 8 ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                <span>Al menos 8 caracteres</span>
              </div>
              <div class="requirement-item" [class.valid]="hasUpperCase(newPassword?.value)">
                <ion-icon [name]="hasUpperCase(newPassword?.value) ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                <span>Una letra mayúscula</span>
              </div>
              <div class="requirement-item" [class.valid]="hasLowerCase(newPassword?.value)">
                <ion-icon [name]="hasLowerCase(newPassword?.value) ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                <span>Una letra minúscula</span>
              </div>
              <div class="requirement-item" [class.valid]="hasNumber(newPassword?.value)">
                <ion-icon [name]="hasNumber(newPassword?.value) ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                <span>Un número</span>
              </div>
            </div>

            <div class="error-message" *ngIf="newPassword?.invalid && newPassword?.touched">
              <ion-icon name="alert-circle"></ion-icon>
              <span>La contraseña debe tener al menos 8 caracteres</span>
            </div>
          </div>

          <!-- Confirmar Contraseña -->
          <div class="input-group">
            <ion-label class="input-label">
              <ion-icon name="lock-closed-outline" class="label-icon"></ion-icon>
              Confirmar Nueva Contraseña <span class="required">*</span>
            </ion-label>
            <ion-item lines="none" class="custom-item" [class.item-error]="(confirmPassword?.invalid || passwordForm.hasError('passwordMismatch')) && confirmPassword?.touched">
              <ion-input 
                [type]="showConfirmPassword ? 'text' : 'password'"
                formControlName="confirmPassword"
                placeholder="Repite la nueva contraseña"
                class="custom-input">
                <ion-icon 
                  [name]="showConfirmPassword ? 'eye-off-outline' : 'eye-outline'" 
                  slot="end" 
                  class="toggle-password"
                  (click)="toggleConfirmPassword()">
                </ion-icon>
              </ion-input>
            </ion-item>
            <div class="error-message" *ngIf="passwordForm.hasError('passwordMismatch') && confirmPassword?.touched">
              <ion-icon name="alert-circle"></ion-icon>
              <span>Las contraseñas no coinciden</span>
            </div>
          </div>

          <!-- Botón Cambiar Contraseña -->
          <ion-button 
            (click)="cambiarPassword()"
            expand="block" 
            [disabled]="passwordForm.invalid"
            class="password-button">
            <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
            Cambiar Contraseña
          </ion-button>

        </form>
      </ion-card-content>
    </ion-card>

  </div>
</ion-content>
<ion-header class="ion-no-border">
  <ion-toolbar class="header-toolbar">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin/dashboard" text=""></ion-back-button>
    </ion-buttons>
    <ion-title>Mi Perfil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="main-content">
  <!-- Spinner de carga -->
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando perfil...</p>
  </div>

  <!-- Contenido del perfil -->
  <div *ngIf="!loading" class="perfil-container">

    <!-- Card principal de perfil -->
    <div class="profile-header-card">
      <div class="profile-avatar">
        {{ getInitials(admin.nombres) }}
      </div>
      <div class="profile-info">
        <h2>{{ admin.nombres }} {{ admin.apellidos }}</h2>
        <p class="profile-email">
          <ion-icon name="mail-outline"></ion-icon>
          {{ admin.email }}
        </p>
        <p class="profile-phone" *ngIf="admin.telefono">
          <ion-icon name="call-outline"></ion-icon>
          {{ admin.telefono }}
        </p>
        <span class="profile-role">{{ admin.rol | uppercase }}</span>
      </div>
    </div>

    <!-- Informaci√≥n Personal Card -->
    <div class="info-card">
      <div class="card-header">
        <h4>üìã Informaci√≥n Personal</h4>
      </div>
      <div class="card-body">
        <div class="info-row">
          <span class="info-label">Registrado:</span>
          <span class="info-value">
            <ion-icon name="calendar-outline"></ion-icon>
            {{ formatDate(admin.created_at) }}
          </span>
        </div>
        <div class="info-row">
          <span class="info-label">√öltima actualizaci√≥n:</span>
          <span class="info-value">
            <ion-icon name="calendar-outline"></ion-icon>
            {{ formatDate(admin.updated_at) }}
          </span>
        </div>
        <div class="info-row">
          <span class="info-label">Estado:</span>
          <span class="info-value badge badge-active">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
            Activo
          </span>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n del Sistema Card -->
    <div class="info-card">
      <div class="card-header">
        <h4>üìä Informaci√≥n del Sistema</h4>
      </div>
      <div class="card-body">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value">{{ systemInfo.totalDocentes }}</div>
            <div class="stat-label">Docentes</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ systemInfo.totalEstudiantes }}</div>
            <div class="stat-label">Estudiantes</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ systemInfo.totalAdministradores }}</div>
            <div class="stat-label">Administradores</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Seguridad Card -->
    <div class="info-card security-card">
      <div class="card-header">
        <h4>üîê Seguridad</h4>
      </div>
      <div class="card-body">
        <div class="security-item">
          <div class="security-info">
            <span class="security-label">Contrase√±a</span>
            <span class="security-desc">√öltima actualizaci√≥n: Hace 30 d√≠as</span>
          </div>
          <span class="security-badge">Segura</span>
        </div>
        <div class="security-item">
          <div class="security-info">
            <span class="security-label">Sesi√≥n Activa</span>
            <span class="security-desc">{{ systemInfo.ultimoAcceso }}</span>
          </div>
          <span class="security-badge active">En l√≠nea</span>
        </div>
      </div>
    </div>

    <!-- Acciones Card -->
    <div *ngIf="!isEditingProfile && !isChangingPassword && !isStoppingAccess" class="action-buttons">
      <ion-button expand="block" (click)="startEditProfile()" class="btn-edit">
        <ion-icon slot="start" name="pencil-outline"></ion-icon>
        Editar Informaci√≥n
      </ion-button>

      <ion-button expand="block" (click)="startChangePassword()" class="btn-password">
        <ion-icon slot="start" name="lock-closed-outline"></ion-icon>
        Cambiar Contrase√±a
      </ion-button>

      <ion-button expand="block" (click)="startStoppingAccess()" class="btn-stop-access">
        <ion-icon slot="start" name="shield-alert-outline"></ion-icon>
        Detener Acceso 
      </ion-button>
    </div>

    <!-- Modal backdrop + Edit Section -->
    <div *ngIf="isEditingProfile" class="modal-backdrop" (click)="cancelEditProfile()">
      <div class="modal-content edit-section" (click)="$event.stopPropagation()">
        <!-- Header Gradient -->
        <div class="modal-header">
          <div class="header-content">
            <h3>
              <ion-icon name="pencil"></ion-icon>
              Editar Informaci√≥n Personal
            </h3>
            <p class="header-subtitle">Actualiza tus datos personales</p>
          </div>
        </div>

        <!-- Form Content -->
        <div class="modal-body">
          <ion-card class="input-card">
            <ion-card-content>
              <!-- Nombres -->
              <ion-item class="input-item">
                <ion-label position="floating">Nombres</ion-label>
                <ion-input type="text" [(ngModel)]="editForm.nombres" placeholder="Ingresa tus nombres">
                </ion-input>
              </ion-item>

              <!-- Divider -->
              <div class="field-divider"></div>

              <!-- Apellidos -->
              <ion-item class="input-item">
                <ion-label position="floating">Apellidos</ion-label>
                <ion-input type="text" [(ngModel)]="editForm.apellidos" placeholder="Ingresa tus apellidos">
                </ion-input>
              </ion-item>

              <!-- Divider -->
              <div class="field-divider"></div>

              <!-- Tel√©fono -->
              <ion-item class="input-item">
                <ion-label position="floating">Tel√©fono</ion-label>
                <ion-input type="tel" [(ngModel)]="editForm.telefono" placeholder="Ingresa tu tel√©fono (opcional)">
                </ion-input>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <!-- Info Helper -->
          <div class="info-helper">
            <ion-icon name="information-circle-outline"></ion-icon>
            <span>Completa los campos para actualizar tu informaci√≥n</span>
          </div>
        </div>

        <!-- Footer Actions -->
        <div class="modal-footer">
          <ion-button expand="block" (click)="saveProfileChanges()" [disabled]="loading" class="btn-save">
            <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
            Guardar Cambios
          </ion-button>

          <ion-button expand="block" (click)="cancelEditProfile()" fill="outline" class="btn-cancel">
            <ion-icon slot="start" name="close-outline"></ion-icon>
            Cancelar
          </ion-button>
        </div>
      </div>
    </div>

    <!-- Modal backdrop + Password Section -->
    <div *ngIf="isChangingPassword" class="modal-backdrop" (click)="cancelChangePassword()">
      <div class="modal-content password-section" (click)="$event.stopPropagation()">
        <!-- Header Gradient -->
        <div class="modal-header password-header">
          <div class="header-content">
            <h3>
              <ion-icon name="key"></ion-icon>
              Cambiar Contrase√±a
            </h3>
            <p class="header-subtitle">Protege tu cuenta con una nueva contrase√±a</p>
          </div>
        </div>

        <!-- Form Content -->
        <div class="modal-body">
          <ion-card class="input-card">
            <ion-card-content>
              <!-- Contrase√±a Actual -->
              <ion-item class="input-item password-item">
                <ion-label position="floating">Contrase√±a Actual</ion-label>
                <ion-input [type]="showCurrentPassword ? 'text' : 'password'" [(ngModel)]="passwordForm.currentPassword">
                </ion-input>
                <ion-icon slot="end" [name]="showCurrentPassword ? 'eye' : 'eye-off'"
                  (click)="togglePasswordVisibility('current')" class="password-toggle">
                </ion-icon>
              </ion-item>

              <!-- Divider -->
              <div class="field-divider"></div>

              <!-- Nueva Contrase√±a -->
              <ion-item class="input-item password-item">
                <ion-label position="floating">Nueva Contrase√±a</ion-label>
                <ion-input [type]="showNewPassword ? 'text' : 'password'" [(ngModel)]="passwordForm.newPassword">
                </ion-input>
                <ion-icon slot="end" [name]="showNewPassword ? 'eye' : 'eye-off'"
                  (click)="togglePasswordVisibility('new')" class="password-toggle">
                </ion-icon>
              </ion-item>

              <!-- Divider -->
              <div class="field-divider"></div>

              <!-- Confirmar Contrase√±a -->
              <ion-item class="input-item password-item">
                <ion-label position="floating">Confirmar Contrase√±a</ion-label>
                <ion-input [type]="showConfirmPassword ? 'text' : 'password'" [(ngModel)]="passwordForm.confirmPassword">
                </ion-input>
                <ion-icon slot="end" [name]="showConfirmPassword ? 'eye' : 'eye-off'"
                  (click)="togglePasswordVisibility('confirm')" class="password-toggle">
                </ion-icon>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <!-- Password Hint -->
          <div class="password-requirements">
            <h4>Requisitos de Seguridad</h4>
            <ul class="requirements-list">
              <li>
                <span class="requirement-check">‚úì</span>
                <span>M√≠nimo 6 caracteres</span>
              </li>
              <li>
                <span class="requirement-check">‚úì</span>
                <span>Incluye may√∫sculas (A-Z)</span>
              </li>
              <li>
                <span class="requirement-check">‚úì</span>
                <span>Incluye n√∫meros (0-9)</span>
              </li>
              <li>
                <span class="requirement-check">‚úì</span>
                <span>Incluye s√≠mbolos (!@#$%)</span>
              </li>
            </ul>
          </div>
        </div>

        <!-- Footer Actions -->
        <div class="modal-footer">
          <ion-button expand="block" (click)="changePassword()" [disabled]="loading" class="btn-save password-btn-save">
            <ion-icon slot="start" name="shield-checkmark-outline"></ion-icon>
            Actualizar Contrase√±a
          </ion-button>

          <ion-button expand="block" (click)="cancelChangePassword()" fill="outline" class="btn-cancel">
            <ion-icon slot="start" name="close-outline"></ion-icon>
            Cancelar
          </ion-button>
        </div>
      </div>
    </div>

    <!-- Modal backdrop + Stop Access Section -->
    <div *ngIf="isStoppingAccess" class="modal-backdrop" (click)="cancelStoppingAccess()">
      <div class="modal-content stop-access-section" (click)="$event.stopPropagation()">
        <!-- Header Gradient -->
        <div class="modal-header stop-access-header">
          <div class="header-content">
            <h3>
              <ion-icon name="shield-alert-outline"></ion-icon>
              Detener Acceso De La Aplicaci√≥n
            </h3>
            <p class="header-subtitle">Esta acci√≥n deshabilitar√° la aplicaci√≥n para docentes y estudiantes</p>
          </div>
        </div>

        <!-- Form Content -->
        <div class="modal-body stop-access-body">
          <!-- Warning Box -->
          <div class="warning-box">
            <ion-icon name="warning-outline"></ion-icon>
            <div class="warning-content">
              <h4>‚ö†Ô∏è Advertencia</h4>
              <p>Al detener el acceso, los siguientes usuarios NO podr√°n usar la aplicaci√≥n:</p>
              <ul>
                <li>Docentes</li>
                <li>Estudiantes</li>
              </ul>
              <div class="warning-note">
                <strong>Nota:</strong> Los administradores seguir√°n teniendo acceso completo a la plataforma.
              </div>
            </div>
          </div>

          <!-- Info Box -->
          <div class="info-box">
            <ion-icon name="information-circle-outline"></ion-icon>
            <div class="info-content">
              <p>Esta acci√≥n es <strong>inmediata</strong> y afectar√° a todos los docentes y estudiantes logueados en la aplicaci√≥n.</p>
            </div>
          </div>
        </div>

        <!-- Footer Actions -->
        <div class="modal-footer">
          <ion-button expand="block" (click)="confirmStopAccess()" [disabled]="loading" class="btn-save stop-access-btn">
            <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
            Confirmar - Detener Acceso
          </ion-button>

          <ion-button expand="block" (click)="cancelStoppingAccess()" fill="outline" class="btn-cancel">
            <ion-icon slot="start" name="close-outline"></ion-icon>
            Cancelar
          </ion-button>
        </div>
      </div>
    </div>

  </div>
</ion-content>